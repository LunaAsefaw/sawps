{% load static %}
<!DOCTYPE html>
<html>
  <head>

    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="shortcut icon" href="/static/favicon.ico" type="image/x-icon">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'js/bootstrap-4.3.1/css/bootstrap.min.css' %}">
    <title>{% block head_title %}Kartoza{% endblock %}</title>
    <link href="{% static 'css/style.css' %}" rel="stylesheet">
    <link href="{% static 'css/navbar.css' %}" rel="stylesheet">
    <link href="https://unpkg.com/maplibre-gl@2.1.9/dist/maplibre-gl.css" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" integrity="sha384-...">

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <!-- Include the CSS file for Select2 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css">
    

    {% block extra_head %}
    {% endblock %}
</head>

<script>
  window.csrfToken = "{{ csrf_token }}";
  window.isLoggedIn = {% if user.is_authenticated %}true{% else %}false{% endif %};
</script>
<body>
  {% block header %}
    {% include 'navibar.html' %}
    {% for message in messages %}
    {% if 'notification' in message.tags %}
      <div class="alert alert-success position-fixed top-0 end-0 padding" role="alert">
        {{ message }}
      </div>
    {% endif %}
  {% endfor %}
  {% endblock %}

  <style>
    /* Position the alert at the top right corner */
    .position-fixed {
        position: fixed;
        z-index: 100; /* Adjust the z-index value as needed */
    }

    .padding {
      margin-top: 6%;
      margin-right: 1%;
    }
  
    .top-0 {
        top: 0;
    }
  
    .end-0 {
        right: 0;
    }
  </style>
    <script>
      // MESSAGES FADE OUT
      $(document).ready(function() {
          // Check if the password-reset-page class exists on the body
          if ( ! $('section').hasClass('password-reset-page')) {
              setTimeout(function() {
                  $('.alert').fadeOut('slow');
              }, 3000); // Adjust the duration (in milliseconds) as needed
          }
      });

      // GET MESSAGES IF ANY
      function getMessageLength() {
        // Try to get the number of messages from localStorage
        let messageLength = parseInt(localStorage.getItem('message_length'));

        return isNaN(messageLength) ? 0 : messageLength;
      }

      // STORE MESSAGES LENGTH
      function storeMessageLength(messageLength) {
        localStorage.setItem('message_length', messageLength);
      }

      // SHOW BELL ICON IF ON PROFILE/REMINDERS PAGE
      function updateBellIcon() {
        const messageLength = getMessageLength();
        var notificationBell = ''
        var notificationBadge = ''
        try{
          notificationBell = document.getElementById('notificationBell');
          notificationBadge = document.querySelector('.notification-badge');
        }catch(exception){
          console.log(exception.message)
        }
        
        if (messageLength > 0) {
          // Display the bell icon with the badge
          notificationBell.style.display = 'block';
          // Set the badge number
           notificationBadge.innerText = messageLength;
        }else if (window.location.href.includes("notifications")) {
          try{
            // reset 
              localStorage.setItem('message_length',0)
            // Hide the bell icon when there are no messages
            notificationBell.style.display = 'none';
          }catch(exception){
            console.log(exception)
          }
        }
      }


      // UPDATE USER IF ANY NEW MESSAGES
      function checkIdleAndReload() {
        let idleTimer;
        let hasUserActivity = false;

        function reloadPage() {
          location.reload();
        }

        function resetIdleTimer() {
          clearTimeout(idleTimer);
          idleTimer = setTimeout(reloadPage, 7000); // if theres no user activity for 7 seconds so as to not interupt some user activity
        }

        document.addEventListener('mousemove', function() {
          hasUserActivity = true;
          resetIdleTimer();
        });

        document.addEventListener('keydown', function() {
          hasUserActivity = true;
          resetIdleTimer();
        });

        setInterval(function() {
          if (!hasUserActivity) {
            const message_length = '{{ messages|length }}'
            if(parseInt(message_length)){
              localStorage.setItem('message_length',message_length)
              reloadPage();
            }
          } else {
            hasUserActivity = false;
          }
        }, 150000); //every 2.5 minutes attempt to get new messages

      }

      
      var message_length = '{{ messages|length }}'
      console.log('messages: ',message_length)
      console.log(window.location.href)

      if(localStorage.getItem('message_length') === null || parseInt(localStorage.getItem('message_length')) === 0){
        if(message_length > 0){
          storeMessageLength(message_length); //store message length
          if(window.location.href.includes("profile") || window.location.href.includes("reminders")){
            setTimeout(function() {
              updateBellIcon();
            }, 300);
          }
        }else
          checkIdleAndReload();
          
      }else if (window.location.href.includes("profile") || window.location.href.includes("reminders")) {

          setTimeout(function() {
            updateBellIcon();
          }, 300);

      }else if(window.location.href.includes("notifications"))
        localStorage.setItem('message_length',0)
      else if(!window.location.href.includes("map") || window.location.href.includes("signup") || window.location.href.includes("login"))
        // continue checking for new messages
        checkIdleAndReload();
      
        
      
        
      

          

  </script>

<div style="min-height:81vh">
{% block content %}
{% endblock %}
</div>
{% block footer %}
<div class='footer' data-testid='footer'>
    <div class='sanbi-footer-logo-container'>
        <img class='footer-logo' data-testid='sanbi-footer-logo'
        src='/static/images/footer/sanbi-footer-logo.png'/>
    </div>
    <div class='footer-nav' data-testid='footer-navigation'>
        <a href='/' target='_blank'>HOME</a>
        <a href='/map' target='_blank'>MAP</a>
        <a href='/' target='_blank'>DOCUMENTATION</a>
        <a href='/contact' target='_blank'>CONTACT</a>
  </div>
  <div class='vendors-logos-container' data-testid='vendors-logos-container'>
    <img class='ids-logo' src='/static/images/footer/ids-logo.png' data-testid='ids-logo'/>
    <img class='kartoza-white-logo' src='/static/images/footer/kartoza-white-logo.png' data-testid='kartoza-logo'/>
  </div>
</div>
{% endblock %}
</body>
</html>
